<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Python, Postgres, and Docker: Running Fast, Meaningful Unit Tests &mdash; CodeSolid.com 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=19645805"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="A Tech Career in Python: From Hobbyist to Professional" href="../python-hobbyist-to-professional/" />
    <link rel="prev" title="The Marketing Genius of 100 Days of Code" href="../the-marketing-genius-of-100-days-of-code/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            CodeSolid.com
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Featured Articles:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../using-latex-in-python/">Using LaTeX In Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing-pyenv-on-a-mac/">Installing Pyenv on a Mac (A Setup Guide With Usage Tips)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conda-vs-pip/">Conda vs. Pip, Venv, and Pyenv – Simplicity Wins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter-password/">Jupyter Password: Easy Notebook and Lab Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Added Recently:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sage/calc3/">Multivariable Calculus Sage Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../complex-inner-products/">The Inner Product of Complex Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started-with-ollama/">Getting Started With Ollama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/yet-another-jdesmos-demo/">Yet Another JDesmos Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/desmos-jupyter/">Using Desmos Graphs in Jupyter Notebooks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Categories</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../category-math-and-math-software/">Math and Math Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-for-beginners-posts/">Python for Beginners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-functions/">Python Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-math-and-science/">Python Math and Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-practice/">Python Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-tools/">Python Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-pandas/">Pandas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../category-miscellaneous/">Other</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../directoryinfo-example/">DirectoryInfo Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vagrant-ansible-local/">Simple Vagrant Ansible Local Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using-testng-with-spring/">Using TestNG With Spring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python-and-aws-getting-started-with-the-cloud-development-kit-cdk/">Python and AWS:  Getting Started with the Cloud Development Kit (CDK)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notes-on-using-postgres-python-and-docker/">Using Postgres, Python, and Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data-cleaning-in-pandas/">Data cleaning in Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-things-done-with-dendron-and-vs-code-first-look/">Getting Things Done With Dendron and VS Code – First Look</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimizing-aws-s3-uploads-with-golang-and-goroutines/">Fast S3 Updates with Golang and Goroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../node-starter-projects/">Node Starter Projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../julia-vs-python-now-for-something-completely-different/">Is Julia Easy to Learn for Python Developers?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../python-and-react-running-python-online-in-a-react-app/">Python and React:  Running Python Online in a React App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-things-done-with-github-markdown-and-visual-studio-code/">Getting Things Done with GitHub, Markdown, and Visual Studio Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../the-marketing-genius-of-100-days-of-code/">The Marketing Genius of 100 Days of Code</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Python, Postgres, and Docker:  Running Fast, Meaningful Unit Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-testing-databases-is-hard">Why Testing Databases Is Hard</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-testing-mistakes">Database Testing Mistakes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unit-testing-apples-running-apples-in-production">Unit Testing Apples, Running Apples in Production</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../python-hobbyist-to-professional/">A Tech Career in Python:  From Hobbyist to Professional</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../category-docker/">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-jupyter/">Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-learn-to-code/">Learn to Code</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">CodeSolid.com</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../category-miscellaneous/">Other</a></li>
      <li class="breadcrumb-item active">Python, Postgres, and Docker:  Running Fast, Meaningful Unit Tests</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/python-postgres-and-docker-running-fast-meaningful-unit-tests.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="python-postgres-and-docker-running-fast-meaningful-unit-tests">
<h1>Python, Postgres, and Docker:  Running Fast, Meaningful Unit Tests<a class="headerlink" href="#python-postgres-and-docker-running-fast-meaningful-unit-tests" title="Link to this heading"></a></h1>
<section id="why-testing-databases-is-hard">
<h2>Why Testing Databases Is Hard<a class="headerlink" href="#why-testing-databases-is-hard" title="Link to this heading"></a></h2>
<p>Testing database code can be much more challenging than testing other code. This is because the very techniques we’ve learned to test other code no longer work perfectly well when testing a database.</p>
<p>There are at least three ways in which database testing is more difficult than testing other types of code.</p>
<p>First, a fundamental principle of unit testing is that we test some aspect of our code in isolation from other things. More specifically, unit tests should be completely stateless – the result of one test should not impact the results of the next. Yet if unit tests should be stateless, a database, in contrast, is as “stateful” as it gets. That’s the whole job of a database – to allow recording and retrieving of application state.</p>
<p>Secondly, testing database code is also challenging because we want our tests to run quickly, yet setting up a database can be a time-consuming process.</p>
<p>Finally, testing a database can be challenging because the teams may be different. As application developers, we can test non-database-related code fine, because we own that code. In the case of the database, a separate team of DBAs may have more final responsibility for the state of the data as well as more domain specific knowledge that we may not have.</p>
</section>
<section id="database-testing-mistakes">
<h2>Database Testing Mistakes<a class="headerlink" href="#database-testing-mistakes" title="Link to this heading"></a></h2>
<p>Because database testing is difficult, it’s an area that’s ripe for mistakes.</p>
<p>I once worked on a project that made a classic mistake that developers make when running database tests: testing against an in-memory database.</p>
<p>In this specific case, the team (who worked in Java) had developed an application that ran on MySQL in production, used the Hibernate ORM to access the database, and ran the unit tests against H2 – an in memory database.</p>
<p>I came onto the team when this stack was mature, and was tasked with fixing a bug that only appeared in the unit tests – it worked fine in production. Before joining the team, I had several years of experience developing database drivers, so I understood that we were essentially testing against one software stack while running in production against a separate stack, a fact that was completely lost on my application-developer colleagues. They couldn’t believe that the behavior could be different since “Hibernate will do the right thing.”</p>
<p>I never was able to fix my colleague’s misconception that this was a perfectly OK thing to do. In the end, I had to fix the bug by going outside of Hibernate and coding a SQL query by hand that provided the right behavior both on MySQL and against the unit tests. You read that right, <em>to fix the bug I had to change code that was working fine in production.</em></p>
<p>Sometimes a team will test against SQLite on developer’s machines since it’s “easy to set up and remove”, but use Postgres (for example) in production. This is another flavor of the same mistake.</p>
</section>
<section id="unit-testing-apples-running-apples-in-production">
<h2>Unit Testing Apples, Running Apples in Production<a class="headerlink" href="#unit-testing-apples-running-apples-in-production" title="Link to this heading"></a></h2>
<p>This article takes as a starting point the idea that the more your test environment differs from your production environment, the more likely you are to have a suite of unit tests that provides low value testing that runs incredibly fast. So</p>
<p>We will develop an example using SQLAlchemy and Postgres, using Docker to set up a baseline database in as little time as possible. Our solution will take have the following features:</p>
<ul class="simple">
<li><p>We’ll use SQLAlchemy both as our application layer and as a utility to create our test database, taking advantage of SQLAlchemy’s ability to apply DDL (Data Definition Language) statements to set up our tables for us.</p></li>
<li><p>Though we won’t use an in-memory database, we’ll take advantage of Docker Layer Caching and Postgres</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../the-marketing-genius-of-100-days-of-code/" class="btn btn-neutral float-left" title="The Marketing Genius of 100 Days of Code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../python-hobbyist-to-professional/" class="btn btn-neutral float-right" title="A Tech Career in Python: From Hobbyist to Professional" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, John Lockwood.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QX7KGT4YPE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QX7KGT4YPE', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>