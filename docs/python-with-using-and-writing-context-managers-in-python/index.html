<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Python With: Using and Writing Context Managers in Python &mdash; CodeSolid.com 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=19645805"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            CodeSolid.com
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Featured Articles:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../using-latex-in-python/">Using LaTeX In Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing-pyenv-on-a-mac/">Installing Pyenv on a Mac (A Setup Guide With Usage Tips)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conda-vs-pip/">Conda vs. Pip, Venv, and Pyenv – Simplicity Wins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter-password/">Jupyter Password: Easy Notebook and Lab Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Added Recently:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../complex-inner-products/">The Inner Product of Complex Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started-with-ollama/">Getting Started With Ollama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/yet-another-jdesmos-demo/">Yet Another JDesmos Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../math/desmos-jupyter/">Using Desmos Graphs in Jupyter Notebooks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Categories</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../category-math-and-math-software/">Math and Math Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-for-beginners-posts/">Python for Beginners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-functions/">Python Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-math-and-science/">Python Math and Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-practice/">Python Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-python-tools/">Python Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-pandas/">Pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-miscellaneous/">Other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-docker/">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-jupyter/">Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../category-learn-to-code/">Learn to Code</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">CodeSolid.com</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Python With: Using and Writing Context Managers in Python</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/python-with-using-and-writing-context-managers-in-python.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="python-with-using-and-writing-context-managers-in-python">
<h1>Python With: Using and Writing Context Managers in Python<a class="headerlink" href="#python-with-using-and-writing-context-managers-in-python" title="Link to this heading"></a></h1>
<p>If you’re an experienced programmer who started in Python, you’re probably at least familiar with the basic uses of the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement. The with statement in Python is an elegant way to manage resources, and is most famously implemented by Python’s <code class="docutils literal notranslate"><span class="pre">open</span></code> function. Here’s a simple example that prints its own contents and exits.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;A short program that displays it&#39;s own contents&quot;&quot;&quot;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>Again, the output of the program is just the contents of the file. The “f” returned by open is a file object, or more accurately in this case, it’s of type TextIOWrapper. The with statement requires a code block, and once we exit the code block, Python will automatically close the file.</p>
<p>All of that is well and good – as I said, we usually learn the basics of the Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement when we first learn how to open a file in Python. Nothing to see here, right?</p>
<p>Well, as with most of Python’s “simple” features, you can look at them in at least two different ways. Of course, you can use the features when you need them on Python classes that already implement them, as we did above in our example. On the other hand, with a little more digging, you can generally find that there’s a mechanism you can use to write your own classes in such a way that they look like they “came with” the language.</p>
<p>We saw many examples of this ability to make custom code appear seamless in our discussion of <a class="reference external" href="https://codesolid.com/dunder-methods-in-python-the-ugliest-awesome-sauce/">Python Dunder Methods</a>. Sure enough, we’ll be encountering such “magic” methods here as well, along with a Python module, contextlib, that will let us easily create “context managers” (classes that can be used with the “with” statement).</p>
<section id="basic-features-of-the-with-statement-in-python">
<h2>Basic Features of The With Statement in Python<a class="headerlink" href="#basic-features-of-the-with-statement-in-python" title="Link to this heading"></a></h2>
<p>To understand what’s going on under the hood when we use a Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement, let’s begin by comparing what it does at a high level, then get into more detail. Simply put, a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement allows us to ensure that a resource always gets freed. In this way, it gives you a slightly more concise way to handle the allocation and de-allocation of a resource that you’d usually manage in a try and finally block. Earlier we showed a sample program that displays its own source code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>This longer program also shows off its own code – but it shouldn’t really brag because in this case, the code is longer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Before getting into other uses of the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement in Python and how you can write custom classes that allow this syntax, let’s deal with a question you may have in mind already.</p>
</section>
<section id="handling-exceptions-in-a-with-statement-code-block">
<h2>Handling Exceptions In a With Statement Code Block<a class="headerlink" href="#handling-exceptions-in-a-with-statement-code-block" title="Link to this heading"></a></h2>
<p>When using a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement, the functionality of a try / finally pair comes for free. In terms of the except clause, however, we still need to code this ourselves. An exception can be raised either when evaluating the “with” line itself or during the block of code it controls.</p>
<p>For example, the open function in Python will raise an OSError (FileNotFoundError) when reading a filename that doesn’t exist. It will raise some other OSError for other cases (such as trying to open a directory).</p>
<p>In addition, an exception might be raised in the block of the open expression, so it’s best to wrap the whole thing in a try block with an except clause, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;not_present.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>Errno<span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory:<span class="w"> </span><span class="s1">&#39;not_present.txt&#39;</span>
</pre></div>
</div>
<p>Well, who could have predicted that “not_present.txt” would end up not being present? Filename humor aside, the important thing to remember about the <em>with</em> statement is that the file will be closed even if we don’t write an exception handler and an exception is thrown.</p>
</section>
<section id="other-uses-of-the-context-manager-in-python">
<h2>Other Uses of the Context Manager in Python<a class="headerlink" href="#other-uses-of-the-context-manager-in-python" title="Link to this heading"></a></h2>
<p>The Python standard library provides many context manager types that are not only valuable in themselves but also serve as illustrative use cases that help us understand when they’re appropriate for our own code. The use cases for Python context managers include:</p>
<ul class="simple">
<li><p>Managing resources that need to be closed. We’ll look at another example of this.</p></li>
<li><p>Managing shared locks, where the resource is acquired temporarily.</p></li>
<li><p>Managing long-running thread-based contexts where a temporary override might be needed.</p></li>
</ul>
<section id="managing-resources-that-need-to-be-closed">
<h3>Managing Resources that Need to Be Closed<a class="headerlink" href="#managing-resources-that-need-to-be-closed" title="Link to this heading"></a></h3>
<p>In the case of resources that need to be closed, the file example we’ve already looked at is the most common. Let’s take another example showing the socket module in use.</p>
<p>To do this, we’ll send a simple HTTP request and read only the first few bytes that come back. That should be enough to show the response was successful. We’ll handle the request with just a socket, which is definitely “the long way”, but it’s an interesting example. For an easier-to-use and much more robust implementation, something like urllib or the requests library is definitely preferred as an HTTP client.</p>
<p>he main point for our purposes is that the socket returned by <code class="docutils literal notranslate"><span class="pre">create_connection</span></code> will be automatically closed when the <code class="docutils literal notranslate"><span class="pre">with</span></code> block exits. We can show this by printing the value of the private member, _close, both within the block and afterward.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;www.w3.org&quot;</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">line_one_length</span> <span class="o">=</span> <span class="mi">17</span>

<span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>  
    <span class="c1"># Send an HTTP request, by hand.  Not for production use!</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;GET / HTTP/1.1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Host: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>    
    
    <span class="c1"># Recieve a one line response</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">line_one_length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    
    <span class="c1"># We&#39;re not closed here</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed in block? </span><span class="si">{</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

<span class="c1"># Now, we will be</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed when block exits? </span><span class="si">{</span><span class="n">sock</span><span class="o">.</span><span class="n">_closed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK

Closed<span class="w"> </span><span class="k">in</span><span class="w"> </span>block?<span class="w"> </span>False.
Closed<span class="w"> </span>when<span class="w"> </span>block<span class="w"> </span>exits?<span class="w"> </span>True.
</pre></div>
</div>
</section>
<section id="managing-locks-in-multi-threaded-code">
<h3>Managing Locks in Multi-Threaded Code<a class="headerlink" href="#managing-locks-in-multi-threaded-code" title="Link to this heading"></a></h3>
<p>Context managers can also be used to automatically manage a thread lock in Python, as an alternative to calling acquire and release. Let’s see how we might safely increment a global variable. Of course, once again, there are simpler ways to write our example, but we want to show the use of a with expression with Python locks to show they are implemented as a context manager type.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Lock</span>

<span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">incrementer</span><span class="p">():</span>    
    <span class="k">global</span> <span class="n">count</span>
    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span>        
        <span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
<span class="c1"># Create some threads</span>
<span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">incrementer</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">count</span></code> is a global resource, we can’t assume that we can increment it and use the value correctly within the same thread. (Try this code without the lock and you’ll see what I mean).</p>
<p>Instead, we use a Lock object from the threading module to limit this part of the operation to a single thread at any given time. As a result, this code reliably prints the numbers from 1 to 100, in the correct order.</p>
<p>Using a with statement ensures that the lock will be reliably released even if an exception is thrown while using it.</p>
</section>
<section id="temporarily-change-a-thread-local-context">
<h3>Temporarily Change a Thread-Local Context<a class="headerlink" href="#temporarily-change-a-thread-local-context" title="Link to this heading"></a></h3>
<p>Python’s standard library also uses a context manager to temporarily override a thread-local context, specifically, the settings that impact the behavior of the Python Decimal class. The Python Decimal type allows you to do arithmetic on numbers that contain a decimal value that is more precise than the default behavior. CPython’s float type is based on the double-precision floating-point values as implemented in C and defined in the <a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a> (floating-point) standard. One of the awkward limitations of this standard is that it does not prevent weird rounding issues, even in cases where you wouldn’t expect them.</p>
<p>We all know that 1.1 plus 2.7 is 3.8, right? Well, yes and no. Because of the way floating-point numbers behave, here’s how it looks in Python:</p>
<p><img alt="" src="../_images/image-117.png" /></p>
<p>Python Decimals allow you one way around this, albeit one that relies on a decimal context that allows you to specify how much precision you want to display. In this case, precision includes all the digits involved, so, for example, knowing that we have two-digit numbers to display, we could do this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>from<span class="w"> </span>decimal<span class="w"> </span>import<span class="w"> </span>*
getcontext<span class="o">()</span>.prec<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
Decimal<span class="o">(</span><span class="m">1</span>.1<span class="o">)</span><span class="w"> </span>+<span class="w"> </span>Decimal<span class="o">(</span><span class="m">2</span>.7<span class="o">)</span>
</pre></div>
</div>
<p>Now we get a value that’s more in line with what we expect to see:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Decimal<span class="o">(</span><span class="s1">&#39;3.8&#39;</span><span class="o">)</span>
</pre></div>
</div>
<p>If your code makes heavy use of the Decimals, however, one problem you may run into is that the context settings you specify as we did above on the line <code class="docutils literal notranslate"><span class="pre">getcontext().prec</span> <span class="pre">=</span> <span class="pre">2</span></code> remain in effect for all the code that runs on the current thread. That may not be what you want.</p>
<p>To avoid this, using the <code class="docutils literal notranslate"><span class="pre">localcontext()</span></code> function in a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement, you can use a context manager that will restore the global DecimalContext when the block exits. In the following example, we’ve indented the output we print inside the with block to make it more clear what’s going on:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">getcontext</span><span class="p">,</span> <span class="n">localcontext</span><span class="p">,</span> <span class="n">Decimal</span>

<span class="c1"># Reset to default precision (if needed)</span>
<span class="n">getcontext</span><span class="p">()</span><span class="o">.</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">28</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1/7 Using high precision: </span><span class="si">{</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Decimal</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># More code requiring high precision</span>
<span class="c1"># ...</span>


<span class="c1"># Temporarily narrow the precision with a context manager:</span>
<span class="k">with</span> <span class="n">localcontext</span><span class="p">()</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Setting decimal precision on what&#39;s returned by localcontext() to 2 in the with block.&quot;</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Calculating 1.1 + 2.7 using low precision: </span><span class="si">{</span><span class="n">Decimal</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Decimal</span><span class="p">(</span><span class="mf">2.7</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Inside the with block, the precision returned by getcontext() is also </span><span class="si">{</span><span class="n">getcontext</span><span class="p">()</span><span class="o">.</span><span class="n">prec</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Outside the block, the precision returned by getcontext() is </span><span class="si">{</span><span class="n">getcontext</span><span class="p">()</span><span class="o">.</span><span class="n">prec</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1/7 Using high precision: </span><span class="si">{</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Decimal</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">1</span>/7<span class="w"> </span>Using<span class="w"> </span>high<span class="w"> </span>precision:<span class="w"> </span><span class="m">0</span>.1428571428571428571428571429

<span class="w">	</span>Setting<span class="w"> </span>decimal<span class="w"> </span>precision<span class="w"> </span>on<span class="w"> </span>what<span class="err">&#39;</span>s<span class="w"> </span>returned<span class="w"> </span>by<span class="w"> </span>localcontext<span class="o">()</span><span class="w"> </span>to<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>with<span class="w"> </span>block.
<span class="w">	</span>Calculating<span class="w"> </span><span class="m">1</span>.1<span class="w"> </span>+<span class="w"> </span><span class="m">2</span>.7<span class="w"> </span>using<span class="w"> </span>low<span class="w"> </span>precision:<span class="w"> </span><span class="m">3</span>.8
<span class="w">	</span>Inside<span class="w"> </span>the<span class="w"> </span>with<span class="w"> </span>block,<span class="w"> </span>the<span class="w"> </span>precision<span class="w"> </span>returned<span class="w"> </span>by<span class="w"> </span>getcontext<span class="o">()</span><span class="w"> </span>is<span class="w"> </span>also<span class="w"> </span><span class="m">2</span>.

Outside<span class="w"> </span>the<span class="w"> </span>block,<span class="w"> </span>the<span class="w"> </span>precision<span class="w"> </span>returned<span class="w"> </span>by<span class="w"> </span>getcontext<span class="o">()</span><span class="w"> </span>is<span class="w"> </span><span class="m">28</span>.
<span class="m">1</span>/7<span class="w"> </span>Using<span class="w"> </span>high<span class="w"> </span>precision:<span class="w"> </span><span class="m">0</span>.1428571428571428571428571429
</pre></div>
</div>
<p>Understanding the three use cases for context managers in the Python standard library can help inform how you might use context managers in your own code. In summary, we’ve seen context managers used to automatically close a resource (files and sockets), manage shared resource locks in multithreaded code, and temporarily set a value without impacting the global setting of that value.</p>
<p>Now that we’ve seen how you use the Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement on some of the context managers from the Python standard library, let’s look at how you can implement context managers on your own custom classes.</p>
</section>
</section>
<section id="adding-support-for-with-to-your-classes-with-a-context-manager">
<h2>Adding Support for With to Your Classes With a Context Manager<a class="headerlink" href="#adding-support-for-with-to-your-classes-with-a-context-manager" title="Link to this heading"></a></h2>
<p>In this section, we want to accomplish two goals:</p>
<ul class="simple">
<li><p>First, we want to show you a fully worked “tutorial” context manager that shows how to implement one by hand. This is so we can demonstrate several things about how context managers behave, including where resources are allocated, how exception handling behaves by default, and how you can override the default to implement an exception handler in behavior.</p></li>
<li><p>Second, once we better understand context manager internals, we want to show how you can implement one more easily using the annotations available in the contextlib library.</p></li>
</ul>
</section>
<section id="a-fully-worked-python-context-manager-example">
<h2>A Fully Worked Python Context Manager Example<a class="headerlink" href="#a-fully-worked-python-context-manager-example" title="Link to this heading"></a></h2>
<p>The following example is somewhat long, but we’ll discuss it after the code listing. Meantime, keep an eye out for the context manager itself, which consists of two methods:</p>
<ul class="simple">
<li><p>__enter__: This is called on entry to the block of code controlled by with.</p></li>
<li><p>__exit__: This is guaranteed to be called when you exit the block of code controlled by with, whether or not an exception is thrown (or handled).</p></li>
</ul>
<p>Here we go:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ffrom</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="nn">AbstractContextManager</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span>

<span class="k">class</span> <span class="nc">DemoContextManager</span><span class="p">(</span><span class="n">AbstractContextManager</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inside __init__:  setting up shop.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span> <span class="o">=</span> <span class="n">raise_exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span> <span class="o">=</span> <span class="n">handle_exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Houston, we have a problem...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Doing something useful.&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inside __enter__: allocating a resource.&quot;</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>            
    
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="n">ex_traceback</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inside __exit__:  deallocating a resource.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle exception internally&quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging an exception of type </span><span class="si">{</span><span class="n">ex_type</span><span class="si">}</span><span class="s2"> with value &#39;</span><span class="si">{</span><span class="n">ex_value</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span>  
</pre></div>
</div>
<p>On line four we declare our class as an implementation of AbstractContextManager. Because Python is <a class="reference external" href="https://docs.python.org/3/glossary.html#term-duck-typing">duck-typed</a>, this is not strictly necessary, but it’s a good practice because it documents what we’re doing. Inside the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method we declare two variables that we’re using for demo purposes, <code class="docutils literal notranslate"><span class="pre">raise_exception</span></code> and <code class="docutils literal notranslate"><span class="pre">handle_exception</span></code>. We use a lock object to illustrate where to acquire and release the resource, not because this example really needs thread safety.</p>
<p>Of course, our class needs to do something in the code block, so with that hint, we now know where <code class="docutils literal notranslate"><span class="pre">do_something</span></code> (lines 12-16) will go when we use the class. It will dutifully demonstrate an exception raised only if you tell it to when you construct the class.</p>
<p>Lines 18-31 represent the context manager proper, that is, the <a class="reference external" href="https://codesolid.com/dunder-methods-in-python-the-ugliest-awesome-sauce/">dunder methods</a>: <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. We use <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> as an opportunity to acquire the lock. The <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method releases the lock, but we also demonstrate a custom exception handler here using the value <code class="docutils literal notranslate"><span class="pre">self.handle_exception</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> returns False (the default in this class), then the exception is bubbled up to the caller. If you want to handle any exceptions inside your context manager class, then you’d return True from <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. Also, if you don’t return a value from __exit__, the exception is also bubbled up to the caller, who then has to handle it as if you returned False. (Recall that if a function returning no value in Python is equivalent to returning None, which is Falsy.)</p>
<p>Most of the code here supports demoing various results. Boiled down to the essentials, what you need for a working context manager are the following things:</p>
<ul class="simple">
<li><p>a working <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> method that acquires any resources you need.</p></li>
<li><p>a working <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method that releases those resources, a return value from <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> that indicates whether you handled the exception (return True) or didn’t (return False).</p></li>
</ul>
<p>Let’s see how this code behaves under various scenarios:</p>
<section id="using-the-defaults-with-no-exceptions">
<h3>Using the Defaults With No Exceptions<a class="headerlink" href="#using-the-defaults-with-no-exceptions" title="Link to this heading"></a></h3>
<p>Here’s a short example showing the parts in action, with no exceptions raised:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DemoContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">dcm</span><span class="p">:</span>
    <span class="n">dcm</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Inside<span class="w"> </span>__init__:<span class="w">  </span>setting<span class="w"> </span>up<span class="w"> </span>shop.
Inside<span class="w"> </span>__enter__:<span class="w"> </span>allocating<span class="w"> </span>a<span class="w"> </span>resource.
Doing<span class="w"> </span>something<span class="w"> </span>useful.
Inside<span class="w"> </span>__exit__:<span class="w">  </span>deallocating<span class="w"> </span>a<span class="w"> </span>resource.
</pre></div>
</div>
<p>As you can see, <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> are called behind the scenes by the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement. Also, <code class="docutils literal notranslate"><span class="pre">__init__</span></code> was called when we constructed the object, as usual. The only method we called explicitly was <code class="docutils literal notranslate"><span class="pre">do_something</span></code>.</p>
<p>In the presence of an exception, unless we tell the context manager to handle the exception, we get the default behavior, a stack trace. Here’s a screenshot showing how it looks in Jupyter Lab:</p>
<p><img alt="" src="../_images/image-213.png" /></p>
<p>Notice that even though an exception was raised in <code class="docutils literal notranslate"><span class="pre">do_something</span></code>, the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> function still ran so the resource was successfully deallocated.</p>
<p>In the next case, we return True from the context manager to indicate that we handled the exception internally.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">raise_exception</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">eat_exception</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">with</span> <span class="n">DemoContextManager</span><span class="p">(</span><span class="n">raise_exception</span><span class="p">,</span> <span class="n">eat_exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">mcm</span><span class="p">:</span>
    <span class="n">mcm</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Inside<span class="w"> </span>__init__:<span class="w">  </span>setting<span class="w"> </span>up<span class="w"> </span>shop.
Inside<span class="w"> </span>__enter__:<span class="w"> </span>allocating<span class="w"> </span>a<span class="w"> </span>resource.
Inside<span class="w"> </span>__exit__:<span class="w">  </span>deallocating<span class="w"> </span>a<span class="w"> </span>resource.
Logging<span class="w"> </span>an<span class="w"> </span>exception<span class="w"> </span>of<span class="w"> </span><span class="nb">type</span><span class="w"> </span>&lt;class<span class="w"> </span><span class="s1">&#39;Exception&#39;</span>&gt;<span class="w"> </span>with<span class="w"> </span>value<span class="w"> </span><span class="s1">&#39;Houston, we have a problem...&#39;</span>.
</pre></div>
</div>
<p>Though it’s probably what you expect, it’s worth noting that as long as it’s inside the <code class="docutils literal notranslate"><span class="pre">with</span></code> block, it doesn’t matter where the exception occurs. It doesn’t have to come from the context manager class code itself – any exceptions raised in the <code class="docutils literal notranslate"><span class="pre">with</span></code> block will be handled the same way. In other words, <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> will always be called, and depending on that function’s return value, the exception will be considered handled or not.</p>
<p>So far we’ve been implementing context managers “the long way”, so we could fully understand the options available and how they behave. In the next section, let’s discuss several of the interesting options that are available to simplify context managers in the <code class="docutils literal notranslate"><span class="pre">contextlib</span></code> module.</p>
</section>
</section>
<section id="python-context-managers-made-easy-with-contextlib">
<h2>Python Context Managers Made Easy With Contextlib<a class="headerlink" href="#python-context-managers-made-easy-with-contextlib" title="Link to this heading"></a></h2>
<p>Although writing a context manager by hand can be illuminating, it is somewhat tedious, especially if you have many uses for simple resource closers. The contextlib module provides many easier-to-use solutions, and there are several interesting examples in the <a class="reference external" href="https://docs.python.org/3/library/contextlib.html">contextlib module documentation</a>. I don’t want to get into repeating the documentation here wholesale, but I do want to summarize a few points.</p>
<p>First, the module supports the same kind of synchronous context managers we’ve been dealing with here, as well as something we haven’t looked at yet, asynchronous contact managers.</p>
<p>Asynchronous context managers can be used with an “<code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code>” expression, to allow things like long io-bound resources to suspend their operation. Their method signatures are declared differently, as shown in the following pseudocode:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">:</span>
     <span class="k">await</span> <span class="n">resource_aquire</span><span class="p">()</span>
     <span class="k">return</span> <span class="bp">self</span>

<span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">():</span>
   <span class="k">await</span> <span class="n">resource_release</span><span class="p">()</span>
   <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>In addition, the contextlib module supports both synchronous and asynchronous context managers via a set of easy-to-use annotations.</p>
<p>Two of these annotations, <code class="docutils literal notranslate"><span class="pre">contextmanager</span></code> and <code class="docutils literal notranslate"><span class="pre">asynccontextmanager</span></code>, are simple decorators that you can use in lieu of a whole class to create a context manager. They both use a simple syntax that uses a generator in the function to be decorated:</p>
<blockquote>
<div><p>The function being decorated must return a <a class="reference external" href="https://docs.python.org/3/glossary.html#term-generator">generator</a>-iterator when called. This iterator must yield exactly one value, which will be bound to the targets in the <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#with"><code class="docutils literal notranslate"><span class="pre">with</span></code></a> statement’s <code class="docutils literal notranslate"><span class="pre">as</span></code> clause, if any.</p>
<p>https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager</p>
</div></blockquote>
<p>To illustrate how easy these are to use here’s a basic example that uses pseudocode, for now:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">managed_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple context manager in a function&quot;&quot;&quot;</span>
    <span class="n">resource_manager</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">resource_manager</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
    <span class="n">resource_manager</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we use the <code class="docutils literal notranslate"><span class="pre">&#64;contextmanager</span></code> annotation on a function, <code class="docutils literal notranslate"><span class="pre">managed_resource</span></code>, and as the documentation requires, we’ve yielded exactly one resource that will be bound to the target of “as”. We’ve also shown where you would allocate the resource and free it.</p>
<p>What I wanted to show here was how little code is required to do this. But with that, here’s a more fleshed-out example that includes the basic idea above along with a lot of print statements to show what’s happening in the various parts of the code including the Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="sd">&quot;&quot;&quot;A contextmanager decorator example with a ResourceManager class&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">ResourceManager</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A resource manager template you might modify for your needs&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_available</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_available</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Did something, the resource was availble.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t do it, sorry -- resource not availble.&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting resource&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_available</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Freeing resource&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_available</span> <span class="o">=</span> <span class="kc">False</span>        

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">managed_resource</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple context manager in a function&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entering context manager function.&quot;</span><span class="p">)</span>
    <span class="n">resource_manager</span> <span class="o">=</span> <span class="n">ResourceManager</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">resource_manager</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
    <span class="n">resource_manager</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting context manager function.&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">managed_resource</span><span class="p">()</span> <span class="k">as</span> <span class="n">managed</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">---- ENTER WITH -------&quot;</span><span class="p">)</span>
    <span class="n">managed</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">---- EXIT WITH -------&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Entering<span class="w"> </span>context<span class="w"> </span>manager<span class="w"> </span><span class="k">function</span>.
Getting<span class="w"> </span>resource
<span class="w">	</span>----<span class="w"> </span>ENTER<span class="w"> </span>WITH<span class="w"> </span>-------
<span class="w">	</span>Did<span class="w"> </span>something,<span class="w"> </span>the<span class="w"> </span>resource<span class="w"> </span>was<span class="w"> </span>availble.
<span class="w">	</span>----<span class="w"> </span>EXIT<span class="w"> </span>WITH<span class="w"> </span>-------
Freeing<span class="w"> </span>resource
Exiting<span class="w"> </span>context<span class="w"> </span>manager<span class="w"> </span><span class="k">function</span>.
</pre></div>
</div>
</section>
<section id="an-asynchronous-context-manager-example">
<h2>An Asynchronous Context Manager Example<a class="headerlink" href="#an-asynchronous-context-manager-example" title="Link to this heading"></a></h2>
<p>I wrote a basic asynchronous context manager example, and I was able to get it working, but let me issue a few caveats before you go off and rely on it as anything more than a tutorial.</p>
<ul class="simple">
<li><p>Asynchronous code in Python becomes somewhat unmanageable quickly because you find that otherwise Pythonic code gets littered with await calls.</p></li>
<li><p>Using this code in “production” would require a lot more testing (not that sqllite3 and “production” really go together anyway). I did get past a lot of the obvious locking issues and the like, so maybe it’s not all that bad, but I wouldn’t rely on it heavily outside of a tutorial.</p></li>
<li><p>I wanted to use a database example for this case, even if only a local one, but realistically async code is more appropriate to remote databases and other network-bound code. That said, sqllite3 has the advantage of being easier to set up.</p></li>
</ul>
<p>OK, with all that apologizing out of the way up front, here’s an implementation of a local key-value store in Python that shows off an asynchronous context manager, based on sqllite3.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>

<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage a filename, closing of the connection, and one time table creation of sqlite3 database.</span>
<span class="sd">    </span>
<span class="sd">       Yield the connection as an asynchronous context manager-manged object, so it </span>
<span class="sd">       can be used by putvalue and getvalue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">db_file</span> <span class="o">=</span> <span class="s2">&quot;keyvalue.db&quot;</span>    
    <span class="n">do_setup</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">do_setup</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">connection</span><span class="p">:</span>            
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE table keyvalue(key varchar unique, value varchar)&quot;</span><span class="p">)</span>
    
    <span class="k">yield</span> <span class="n">connection</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    
<span class="k">async</span> <span class="k">def</span> <span class="nf">putvalue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Put a value to keyvalue.db&#39;s keyvalue table identified by key.  Does an insert or update as needed.&quot;&quot;&quot;</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="k">await</span> <span class="n">getvalue</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
    <span class="k">async</span> <span class="k">with</span> <span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into keyvalue(key, value) values(?, ?);&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update keyvalue set value = ? where key = ?;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">])</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    
<span class="k">async</span> <span class="k">def</span> <span class="nf">getvalue</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves a by key from keyvalue.db&#39;s keyvalue table, or None if does not exist.&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select value from keyvalue where key = ?;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>Whew! That’s a lot for one example. The context manager is handling closing the (underlying) connection here, which the sqlite3’s context manager does not take care of. It also manages the one-time setup of a database table that we need. This context manager is consumed by <code class="docutils literal notranslate"><span class="pre">putvalue</span></code> and <code class="docutils literal notranslate"><span class="pre">getvalue</span></code>, our hecka-simple key-value store interface. (Well, it would be hecka-simple if it weren’t for the fact that, as I mentioned, async code tends to take over the entire codebase.) It even bubbles out to the client, but as I said, it works OK. Here’s a sample session:</p>
<p><img alt="" src="../_images/image-310.png" /></p>
</section>
<section id="other-contextlib-utilities">
<h2>Other Contextlib Utilities<a class="headerlink" href="#other-contextlib-utilities" title="Link to this heading"></a></h2>
<p>Beyond the generator-based functions, the contextlib module has a lot more interesting decorators and functions that you can use.</p>
<p>For example, here’s a simple website-checker I wrote using the closing function, which takes whatever you want to automatically close even if all else goes wrong.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>

<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">&#39;https://codesolid.com&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">page</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;codesolid.com is up and running!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected or erro status for codesolid.com. Please check.  Status = </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Needless to say, the site is currently up and running or you couldn’t be reading this!</p>
<p>The contextlib module also features an exception suppressor you can use if you know you’re not interested in a specific exception.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>

<span class="k">def</span> <span class="nf">chicken_little</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s2">&quot;The sky is falling!&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">SystemError</span><span class="p">):</span>
    <span class="n">chicken_little</span><span class="p">()</span>
</pre></div>
</div>
<p>Of course, no discerning codesolid.com reader would ever suppress an exception without a good reason, right? For the rest of the community, the Python documentation includes this “Don’t spill hot coffee on your lap” warning label:</p>
<blockquote>
<div><p>As with any other mechanism that completely suppresses exceptions, this context manager should be used only to cover very specific errors where silently continuing with program execution is known to be the right thing to do.</p>
<p>https://docs.python.org/3/library/contextlib.html#contextlib.suppress</p>
</div></blockquote>
</section>
<section id="closing-thoughts">
<h2>Closing Thoughts<a class="headerlink" href="#closing-thoughts" title="Link to this heading"></a></h2>
<p>As always, I hope you found reading this article to be as interesting as I found writing it to be. Our journey to write a context manager by hand showed us a lot about how context managers behave. The core of it was quite easy to implement, an <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> method that returns a resource, and an <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method that frees it.</p>
<p>To make things even simpler, the contextlib module makes creating code to work with the Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement quite easy to do. The contextmanager annotation in that module is especially useful.</p>
</section>
<section id="you-may-also-enjoy">
<h2>You May Also Enjoy<a class="headerlink" href="#you-may-also-enjoy" title="Link to this heading"></a></h2>
<p><a class="reference external" href="https://codesolid.com/python-format-strings/">Python Format Strings: From Beginner to Expert</a></p>
<p><a class="reference external" href="https://codesolid.com/python-operators/">Python Operators: The Building Blocks of Successful Code</a></p>
<p><a class="reference external" href="https://codesolid.com/python-dataclasses/">Python Dataclass: Easily Automate Class Best Practices</a></p>
<p><a class="reference external" href="https://codesolid.com/python-indexing-slicing-exercises/">Python Indexing and Slicing: Complete Tutorial and Hands-On Exercises</a></p>
<p><a class="reference external" href="https://codesolid.com/random-python-secrets-and-random-values-made-easy/">Random Python: Secrets and Random Values Made Easy</a></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, John Lockwood.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QX7KGT4YPE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QX7KGT4YPE', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>